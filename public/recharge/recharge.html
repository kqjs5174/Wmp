<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å……å€¼ä¸­å¿ƒ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: #1890ff;
      color: #fff;
      padding: 24px 20px;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .header-desc {
      font-size: 13px;
      opacity: 0.85;
      margin-bottom: 16px;
    }
    
    .user-section {
      margin-top: 12px;
    }
    
    .user-section label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      opacity: 0.9;
    }
    
    .user-row {
      display: flex;
      gap: 8px;
    }
    
    .user-row input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .user-row button {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }
    
    .user-row button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .user-display {
      display: none;
      font-size: 14px;
    }
    
    .user-display .name {
      font-weight: 500;
    }
    
    .user-display .change {
      margin-left: 8px;
      font-size: 12px;
      opacity: 0.8;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .points-row {
      margin-top: 10px;
      font-size: 13px;
      display: none;
    }
    
    .points-row span {
      font-size: 20px;
      font-weight: 500;
    }
    
    .content {
      padding: 20px;
      display: none;
    }
    
    .section-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .amount-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .amount-item {
      padding: 12px 8px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    
    .amount-item:hover {
      border-color: #1890ff;
    }
    
    .amount-item.selected {
      border-color: #1890ff;
      background: #e6f7ff;
    }
    
    .amount-item .num {
      font-size: 18px;
      font-weight: 500;
      color: #333;
    }
    
    .amount-item .unit {
      font-size: 12px;
      color: #666;
    }
    
    .amount-item .pts {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }
    
    .custom-input {
      margin-bottom: 16px;
    }
    
    .custom-input label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }
    
    .input-box {
      display: flex;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .input-box:focus-within {
      border-color: #1890ff;
    }
    
    .input-box .symbol {
      padding: 8px 12px;
      background: #fafafa;
      color: #666;
      border-right: 1px solid #d9d9d9;
    }
    
    .input-box input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      outline: none;
      font-size: 14px;
    }
    
    .submit-btn {
      width: 100%;
      padding: 12px;
      background: #1890ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 15px;
      cursor: pointer;
    }
    
    .submit-btn:hover {
      background: #40a9ff;
    }
    
    .submit-btn:disabled {
      background: #d9d9d9;
      cursor: not-allowed;
    }
    
    .info-box {
      margin-top: 16px;
      padding: 12px;
      background: #fafafa;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
      line-height: 1.8;
    }
    
    .info-box h4 {
      font-size: 13px;
      color: #333;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .info-box ul {
      padding-left: 16px;
      margin: 0;
    }
    
    .link-row {
      margin-top: 16px;
      text-align: center;
    }
    
    .link-row a {
      color: #1890ff;
      text-decoration: none;
      font-size: 13px;
    }
    
    .link-row a:hover {
      text-decoration: underline;
    }
    
    /* ç­¾åˆ°æ ·å¼ */
    .checkin-section {
      margin-bottom: 20px;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      color: #fff;
    }
    
    .checkin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .checkin-title {
      font-size: 16px;
      font-weight: 500;
    }
    
    .checkin-btn {
      padding: 8px 20px;
      background: #fff;
      color: #667eea;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .checkin-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .checkin-btn:disabled {
      background: rgba(255,255,255,0.5);
      color: rgba(102,126,234,0.7);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .checkin-btn.checked {
      background: rgba(255,255,255,0.3);
      color: #fff;
    }
    
    .checkin-info {
      display: flex;
      gap: 20px;
      font-size: 13px;
      opacity: 0.9;
    }
    
    .checkin-info-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .checkin-info-item .num {
      font-size: 18px;
      font-weight: 600;
    }
    
    .checkin-reward {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 12px;
      opacity: 0.85;
    }
    
    .checkin-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 200;
      display: none;
      text-align: center;
    }
    
    .checkin-toast.show {
      display: block;
      animation: fadeInOut 2s ease;
    }
    
    .checkin-toast .points-add {
      font-size: 24px;
      font-weight: 600;
      color: #52c41a;
      margin: 8px 0;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }
    
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .loading.show {
      display: flex;
    }
    
    .loading-content {
      background: #fff;
      padding: 24px 32px;
      border-radius: 4px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #f0f0f0;
      border-top-color: #1890ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .welcome-info {
      padding: 40px 20px;
      text-align: center;
    }
    
    .welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .welcome-title {
      font-size: 18px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    
    .welcome-text {
      font-size: 13px;
      color: #888;
      margin-bottom: 24px;
    }
    
    .welcome-tips {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    
    .tip-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #666;
    }
    
    .tip-num {
      width: 20px;
      height: 20px;
      background: #1890ff;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>å……å€¼ä¸­å¿ƒ</h1>
      <div class="header-desc" id="headerDesc">å……å€¼ç§¯åˆ†ï¼Œäº«å—æ›´å¤šæœåŠ¡</div>
      
      <div class="user-section" id="userSection">
        <label>è¯·è¾“å…¥ç”¨æˆ·åå¼€å§‹å……å€¼</label>
        <div class="user-row" id="userInput">
          <input type="text" id="usernameField" placeholder="è¾“å…¥ç”¨æˆ·å" />
          <button onclick="setUser()">ç¡®å®š</button>
        </div>
        <div class="user-display" id="userDisplay">
          <span class="name" id="userName"></span>
        </div>
      </div>
      
      <div class="points-row" id="pointsRow">
        ç§¯åˆ†ï¼š<span id="points">0</span>
      </div>
    </div>
    
    <div class="welcome-info" id="welcomeInfo">
      <div class="welcome-icon">ğŸ’°</div>
      <div class="welcome-title">ç§¯åˆ†å……å€¼</div>
      <div class="welcome-text">è¾“å…¥ç”¨æˆ·ååå³å¯é€‰æ‹©å……å€¼é‡‘é¢</div>
      <div class="welcome-tips">
        <div class="tip-item"><span class="tip-num">1</span>è¾“å…¥ç”¨æˆ·å</div>
        <div class="tip-item"><span class="tip-num">2</span>é€‰æ‹©å……å€¼é‡‘é¢</div>
        <div class="tip-item"><span class="tip-num">3</span>å®Œæˆæ”¯ä»˜è·å¾—ç§¯åˆ†</div>
      </div>
    </div>
    
    <div class="content" id="mainContent">
      <!-- ç­¾åˆ°åŒºåŸŸ -->
      <div class="checkin-section" id="checkinSection">
        <div class="checkin-header">
          <div class="checkin-title">ğŸ“… æ¯æ—¥ç­¾åˆ°</div>
          <button class="checkin-btn" id="checkinBtn" onclick="doCheckin()">ç­¾åˆ°é¢†ç§¯åˆ†</button>
        </div>
        <div class="checkin-info">
          <div class="checkin-info-item">
            <span>ç´¯è®¡ç­¾åˆ°</span>
            <span class="num" id="totalCheckins">0</span>
            <span>å¤©</span>
          </div>
          <div class="checkin-info-item">
            <span>ä»Šæ—¥å¯å¾—</span>
            <span class="num" id="todayReward">1-12</span>
            <span>ç§¯åˆ†</span>
          </div>
        </div>
        <div class="checkin-reward" id="checkinReward">
          æ¯æ—¥ç­¾åˆ°éšæœºè·å¾— 1-12 ç§¯åˆ†
        </div>
      </div>
      
      <div class="section-label">é€‰æ‹©é‡‘é¢</div>
      <div class="amount-grid" id="amountGrid">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div class="custom-input">
        <label>è‡ªå®šä¹‰é‡‘é¢</label>
        <div class="input-box">
          <span class="symbol">Â¥</span>
          <input type="number" id="customField" placeholder="è¾“å…¥é‡‘é¢" min="1" max="10000" />
        </div>
      </div>
      
      <button class="submit-btn" id="submitBtn" onclick="pay()">ç«‹å³å……å€¼</button>
      
      <div class="info-box">
        <h4>è¯´æ˜</h4>
        <ul>
          <li id="ratioInfo">1å…ƒ = 1ç§¯åˆ†</li>
          <li>é‡‘é¢èŒƒå›´ï¼š1-10000å…ƒ</li>
          <li>å……å€¼åç§¯åˆ†å®æ—¶åˆ°è´¦</li>
        </ul>
      </div>
      
      <div class="link-row">
        <a href="recharge_result.html">å……å€¼è®°å½•</a>
      </div>
    </div>
  </div>
  
  <div class="loading" id="loading">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div>å¤„ç†ä¸­...</div>
    </div>
  </div>
  
  <!-- ç­¾åˆ°æˆåŠŸæç¤º -->
  <div class="checkin-toast" id="checkinToast">
    <div>ğŸ‰ ç­¾åˆ°æˆåŠŸ</div>
    <div class="points-add" id="checkinPointsAdd">+10</div>
    <div id="checkinToastMsg">è¿ç»­ç­¾åˆ° 1 å¤©</div>
  </div>

  <script>
    var amount = 0;
    var username = '';
    var POINTS_RATIO = 1; // é»˜è®¤å€¼ï¼Œä¼šä»APIè·å–
    var PAY_URL = ''; // æ”¯ä»˜æ¥å£åœ°å€ï¼Œä»é…ç½®è·å–
    var ORDERS_URL = '/api/orders'; // ä½¿ç”¨æœ¬åœ°è®¢å•æ¥å£
    var CONFIG_URL = '/api/config';
    var USER_VALIDATE_URL = '/api/user/validate'; // æœ¬åœ°ç”¨æˆ·éªŒè¯æ¥å£
    var USER_POINTS_URL = '/api/user/points'; // æœ¬åœ°ç”¨æˆ·ç§¯åˆ†æ¥å£
    var CHECKIN_URL = '/api/checkin'; // ç­¾åˆ°æ¥å£
    var CHECKIN_STATUS_URL = '/api/checkin/status'; // ç­¾åˆ°çŠ¶æ€æ¥å£
    var CHECKIN_CONFIG_URL = '/api/checkin/config'; // ç­¾åˆ°é…ç½®æ¥å£
    
    // ç­¾åˆ°é…ç½®
    var checkinConfig = {
      basePoints: 10,
      continuousBonus: 5,
      maxContinuousBonus: 50
    };
    
    // é‡‘é¢é€‰é¡¹
    var amountOptions = [10, 30, 50, 100, 200, 500];
    
    document.addEventListener('DOMContentLoaded', function() {
      // å…ˆåŠ è½½é…ç½®
      loadConfig().then(function() {
        initGrid();
        initCustom();
        
        // ä¼˜å…ˆä» currentUser è·å–ç™»å½•ç”¨æˆ·åï¼ˆç®¡ç†é¡µé¢ç™»å½•åå­˜å‚¨ï¼‰
        var currentUserStr = localStorage.getItem('currentUser');
        var saved = localStorage.getItem('recharge_user');
        var autoUsername = null;
        
        if (currentUserStr) {
          try {
            var currentUser = JSON.parse(currentUserStr);
            if (currentUser && currentUser.username) {
              autoUsername = currentUser.username;
            }
          } catch (e) {
            console.error('è§£æ currentUser å¤±è´¥:', e);
          }
        }
        
        // å¦‚æœæœ‰ç™»å½•ç”¨æˆ·ï¼Œè‡ªåŠ¨è®¾ç½®
        if (autoUsername) {
          document.getElementById('usernameField').value = autoUsername;
          setUser();
        } else if (saved) {
          // å¦åˆ™ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„ç”¨æˆ·å
          document.getElementById('usernameField').value = saved;
          setUser();
        }
        
        document.getElementById('usernameField').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') setUser();
        });
      });
    });
    
    // ä»åç«¯åŠ è½½é…ç½®
    function loadConfig() {
      return fetch(CONFIG_URL)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.code === 0 && data.data) {
            POINTS_RATIO = data.data.pointsRatio || 1;
            // è®¾ç½®æ”¯ä»˜æ¥å£åœ°å€
            if (data.data.payUrl) {
              PAY_URL = data.data.payUrl;
            }
            // æ›´æ–°è¯´æ˜æ–‡å­—
            document.getElementById('ratioInfo').textContent = '1å…ƒ = ' + POINTS_RATIO + 'ç§¯åˆ†';
          }
        })
        .catch(function(e) {
          console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
        });
    }
    
    // éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼ˆä½¿ç”¨æœ¬åœ°APIï¼‰
    function validateUser(inputUsername) {
      return fetch(USER_VALIDATE_URL + '?username=' + encodeURIComponent(inputUsername))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.code === 0 && data.data) {
            return data.data.exists;
          }
          return false;
        })
        .catch(function(e) {
          console.error('éªŒè¯ç”¨æˆ·å¤±è´¥:', e);
          // éªŒè¯å¤±è´¥æ—¶é»˜è®¤å…è®¸ï¼ˆå¯èƒ½æ˜¯æ²¡æœ‰é…ç½®ç”¨æˆ·åˆ—è¡¨ï¼‰
          return true;
        });
    }
    
    function initGrid() {
      var grid = document.getElementById('amountGrid');
      var html = '';
      
      amountOptions.forEach(function(val) {
        var pts = val * POINTS_RATIO;
        html += '<div class="amount-item" data-val="' + val + '">' +
          '<div class="num">' + val + '</div>' +
          '<div class="unit">å…ƒ</div>' +
          '<div class="pts">' + pts + 'ç§¯åˆ†</div>' +
        '</div>';
      });
      
      grid.innerHTML = html;
      
      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      var items = document.querySelectorAll('.amount-item');
      items.forEach(function(item) {
        item.addEventListener('click', function() {
          items.forEach(function(i) { i.classList.remove('selected'); });
          item.classList.add('selected');
          amount = parseInt(item.dataset.val);
          document.getElementById('customField').value = '';
        });
      });
    }
    
    function initCustom() {
      var field = document.getElementById('customField');
      field.addEventListener('input', function() {
        document.querySelectorAll('.amount-item').forEach(function(i) {
          i.classList.remove('selected');
        });
        amount = parseInt(field.value) || 0;
      });
    }
    
    function setUser() {
      var val = document.getElementById('usernameField').value.trim();
      if (!val) {
        alert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showLoading(true);
      
      // éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
      validateUser(val).then(function(exists) {
        showLoading(false);
        
        if (!exists) {
          alert('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦æ­£ç¡®');
          return;
        }
        
        username = val;
        localStorage.setItem('recharge_user', val);
        
        document.getElementById('userInput').style.display = 'none';
        document.getElementById('userDisplay').style.display = 'block';
        document.getElementById('userName').textContent = val;
        document.getElementById('pointsRow').style.display = 'block';
        document.getElementById('welcomeInfo').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('headerDesc').style.display = 'none';
        
        loadPoints();
      });
    }
    
    function switchUser() {
      username = '';
      localStorage.removeItem('recharge_user');
      document.getElementById('userInput').style.display = 'flex';
      document.getElementById('userDisplay').style.display = 'none';
      document.getElementById('pointsRow').style.display = 'none';
      document.getElementById('welcomeInfo').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('headerDesc').style.display = 'block';
      document.getElementById('usernameField').value = '';
      document.getElementById('points').textContent = '0';
    }
    
    function loadPoints() {
      if (!username) return;
      
      // ä½¿ç”¨æœ¬åœ°ç”¨æˆ·ç§¯åˆ†æ¥å£
      fetch(USER_POINTS_URL + '?username=' + encodeURIComponent(username))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.code === 0 && data.data) {
            document.getElementById('points').textContent = data.data.totalPoints || 0;
          } else {
            document.getElementById('points').textContent = '0';
          }
        })
        .catch(function() {
          document.getElementById('points').textContent = '--';
        });
    }
    
    function showLoading(show) {
      var el = document.getElementById('loading');
      if (show) el.classList.add('show');
      else el.classList.remove('show');
    }
    
    function genOrderId() {
      var d = new Date();
      var ts = d.getFullYear().toString() +
        String(d.getMonth() + 1).padStart(2, '0') +
        String(d.getDate()).padStart(2, '0') +
        String(d.getHours()).padStart(2, '0') +
        String(d.getMinutes()).padStart(2, '0') +
        String(d.getSeconds()).padStart(2, '0');
      var rand = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return username + '_' + ts + '_' + rand;
    }
    
    function pay() {
      if (!amount || amount < 1) {
        alert('è¯·é€‰æ‹©æˆ–è¾“å…¥é‡‘é¢');
        return;
      }
      if (amount > 10000) {
        alert('é‡‘é¢ä¸èƒ½è¶…è¿‡10000å…ƒ');
        return;
      }
      
      showLoading(true);
      
      var orderId = genOrderId();
      
      setTimeout(function() {
        showLoading(false);
        var url = PAY_URL + '?amount=' + amount + '&order_id=' + encodeURIComponent(orderId);
        window.open(url, '_blank');
        
        setTimeout(function() {
          if (confirm('æ”¯ä»˜å®Œæˆåç‚¹å‡»ç¡®å®šæŸ¥çœ‹ç»“æœ')) {
            window.location.href = 'recharge_result.html?order_id=' + encodeURIComponent(orderId);
          }
        }, 500);
      }, 300);
    }
    
    // ========== ç­¾åˆ°åŠŸèƒ½ ==========
    
    // åŠ è½½ç­¾åˆ°é…ç½®
    function loadCheckinConfig() {
      return fetch(CHECKIN_CONFIG_URL)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.code === 0 && data.data) {
            checkinConfig = data.data;
            updateCheckinRewardText();
          }
        })
        .catch(function(e) {
          console.error('åŠ è½½ç­¾åˆ°é…ç½®å¤±è´¥:', e);
        });
    }
    
    // æ›´æ–°ç­¾åˆ°å¥–åŠ±è¯´æ˜æ–‡å­—
    function updateCheckinRewardText() {
      // éšæœºç§¯åˆ†æ¨¡å¼ï¼Œä¸éœ€è¦æ›´æ–°æ–‡å­—
      document.getElementById('checkinReward').textContent = 'æ¯æ—¥ç­¾åˆ°éšæœºè·å¾— 1-12 ç§¯åˆ†';
    }
    
    // åŠ è½½ç­¾åˆ°çŠ¶æ€
    function loadCheckinStatus() {
      if (!username) return;
      
      fetch(CHECKIN_STATUS_URL + '?username=' + encodeURIComponent(username))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.code === 0 && data.data) {
            var status = data.data;
            
            // æ›´æ–°ç´¯è®¡ç­¾åˆ°å¤©æ•°
            document.getElementById('totalCheckins').textContent = status.totalCheckins || 0;
            
            // ä»Šæ—¥å¯å¾—ç§¯åˆ†æ˜¾ç¤ºä¸ºèŒƒå›´ï¼ˆéšæœºæ¨¡å¼ï¼‰
            document.getElementById('todayReward').textContent = '1-12';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            var btn = document.getElementById('checkinBtn');
            if (status.hasCheckedInToday) {
              btn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ° âœ“';
              btn.classList.add('checked');
              btn.disabled = true;
            } else {
              btn.textContent = 'ç­¾åˆ°é¢†ç§¯åˆ†';
              btn.classList.remove('checked');
              btn.disabled = false;
            }
          }
        })
        .catch(function(e) {
          console.error('åŠ è½½ç­¾åˆ°çŠ¶æ€å¤±è´¥:', e);
        });
    }
    
    // æ‰§è¡Œç­¾åˆ°
    function doCheckin() {
      if (!username) {
        alert('è¯·å…ˆç™»å½•');
        return;
      }
      
      var btn = document.getElementById('checkinBtn');
      if (btn.disabled) return;
      
      btn.disabled = true;
      btn.textContent = 'ç­¾åˆ°ä¸­...';
      
      fetch(CHECKIN_URL + '?username=' + encodeURIComponent(username))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.code === 0 && data.data) {
            var result = data.data;
            
            // æ˜¾ç¤ºç­¾åˆ°æˆåŠŸæç¤º (åç«¯è¿”å› rewardPoints å’Œ totalCheckins)
            showCheckinToast(result.rewardPoints, result.totalCheckins);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            btn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ° âœ“';
            btn.classList.add('checked');
            
            // æ›´æ–°ç´¯è®¡ç­¾åˆ°å¤©æ•°
            document.getElementById('totalCheckins').textContent = result.totalCheckins;
            
            // åˆ·æ–°ç§¯åˆ†æ˜¾ç¤º
            loadPoints();
            
            // ä»Šæ—¥å¯å¾—ç§¯åˆ†ä¿æŒæ˜¾ç¤ºèŒƒå›´
            document.getElementById('todayReward').textContent = '1-12';
          } else {
            alert(data.msg || 'ç­¾åˆ°å¤±è´¥');
            btn.disabled = false;
            btn.textContent = 'ç­¾åˆ°é¢†ç§¯åˆ†';
          }
        })
        .catch(function(e) {
          console.error('ç­¾åˆ°å¤±è´¥:', e);
          alert('ç­¾åˆ°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
          btn.disabled = false;
          btn.textContent = 'ç­¾åˆ°é¢†ç§¯åˆ†';
        });
    }
    
    // æ˜¾ç¤ºç­¾åˆ°æˆåŠŸæç¤º
    function showCheckinToast(points, totalDays) {
      var toast = document.getElementById('checkinToast');
      document.getElementById('checkinPointsAdd').textContent = '+' + points;
      document.getElementById('checkinToastMsg').textContent = 'ç´¯è®¡ç­¾åˆ° ' + totalDays + ' å¤©';
      
      toast.classList.add('show');
      
      setTimeout(function() {
        toast.classList.remove('show');
      }, 2000);
    }
    
    // ä¿®æ”¹ setUser å‡½æ•°ï¼Œåœ¨ç”¨æˆ·ç™»å½•ååŠ è½½ç­¾åˆ°çŠ¶æ€
    var originalSetUser = setUser;
    setUser = function() {
      var val = document.getElementById('usernameField').value.trim();
      if (!val) {
        alert('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }
      
      showLoading(true);
      
      validateUser(val).then(function(exists) {
        showLoading(false);
        
        if (!exists) {
          alert('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦æ­£ç¡®');
          return;
        }
        
        username = val;
        localStorage.setItem('recharge_user', val);
        
        document.getElementById('userInput').style.display = 'none';
        document.getElementById('userDisplay').style.display = 'block';
        document.getElementById('userName').textContent = val;
        document.getElementById('pointsRow').style.display = 'block';
        document.getElementById('welcomeInfo').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('headerDesc').style.display = 'none';
        
        loadPoints();
        loadCheckinConfig().then(function() {
          loadCheckinStatus();
        });
      });
    };
  </script>
</body>
</html>
